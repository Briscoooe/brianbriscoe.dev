<!DOCTYPE html>
<html lang="en">
  <head>
    <meta
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
      name="viewport"
    />
    <meta charset="utf-8" />
    <title>Brian Briscoe - Resume</title>
    <link href="index.css" rel="stylesheet" />
    <style>
      #app {
        font-size: 1rem;
      }
      #output {
        font-family: Inter, sans-serif;
      }
      .rounded {
        border-radius: 0.5rem;
      }
      button {
        font-size: 1.2rem;
        padding: 0.75rem 1rem;
        border: 1px solid #ccc;
        background-color: #444e60;
        color: white;
        cursor: pointer;
      }
      button:disabled {
        background-color: #ccc;
        color: white;
        cursor: not-allowed;
      }
      input {
        width: 100%;
        font-size: 1.25rem;
        padding: 0.75rem 1rem;
        border: 1px solid #ccc;
        background-color: white;
      }
      select {
        margin: 0.5rem 0;
        padding: 0.5rem 1rem;
        border: 1px solid #ccc;
        font-size: 1.25rem;
      }
    </style>
    <script src="components/header-component.js"></script>
    <script src="components/popup-component.js"></script>
    <script type="module">
      import { h, render } from "https://esm.sh/preact";
      import { useState } from "https://esm.sh/preact/hooks";
      import htm from "https://esm.sh/htm";
      const apiUrl = "https://resumai.fly.dev";

      const html = htm.bind(h);
      const exampleQuestions = [
        "Where did Brian go to school?",
        "What technologies does Brian know?",
        "How many years of experience does Brian have?",
      ];
      const personas = ["normal", "friendly", "poet", "rapper"];
      const languages = ["en", "es", "fr", "de", "it", "pt"];

      function ExampleQuestion(props) {
        const { question, onClick } = props;
        return html`<button onClick=${() => onClick(question)}>
          ${question}
        </button>`;
      }

      function App() {
        const [output, setOutput] = useState("");
        const [message, setMessage] = useState("");
        const [persona, setPersona] = useState("normal");
        const [language, setLanguage] = useState("en");
        const [isLoading, setIsLoading] = useState(false);
        const [history, setHistory] = useState([]);

        // this has to be done this way due to Preact weirdness with useState
        const appendHistory = (currentHistory, message, actor) => {
          setHistory([...currentHistory, { message, actor }]);
        };
        const sendChatMessage = async (message) => {
          const currentHistory = [...history];
          appendHistory(currentHistory, message, "user");
          currentHistory.push({ message, actor: "user" });
          setOutput("");
          setMessage("");
          setIsLoading(true);
          const response = await fetch(
            `${apiUrl}/chat?${new URLSearchParams({
              message,
              persona,
              language,
            })}`,
            {
              method: "GET",
            }
          );
          const reader = response.body
            .pipeThrough(new TextDecoderStream())
            .getReader();
          let str = "";
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            str += value;
            setOutput(str);
          }
          setIsLoading(false);
          appendHistory(currentHistory, str, "bot");
        };
        const clicked = () => {
          sendChatMessage(message);
        };

        const handleInput = (e) => {
          setMessage(e.target.value);
        };

        // <a href="https://github.com/briscoooe/resumai" style="color:red">
        //   <img src="./assets/github.svg" alt="github" />
        // </a>
        // <select onChange=${(e) => setPersona(e.target.value)}>
        //   ${personas.map((persona) => {
        //     return html`<option value=${persona}>${persona}</option>`;
        //   })}
        // </select>
        // <select onChange=${(e) => setLanguage(e.target.value)}>
        //   ${languages.map((language) => {
        //     return html`<option value=${language}>${language}</option>`;
        //   })}
        // </select>
        // <hr />
        return html`
          <div style="display: flex;flex-direction: column">
            <div
              style="display: flex;flex-direction: row;justify-content: space-between;"
            >
              <input
                placeholder="Tell me about Brian"
                type="text"
                class="rounded"
                value=${message}
                onInput=${handleInput}
              />
              <button
                class="rounded"
                style="margin-left: 1rem"
                disabled=${message.length < 5}
                onClick=${clicked}
              >
                <img
                  height="24"
                  width="24"
                  src="./assets/airplane.svg"
                  alt="send"
                />
              </button>
            </div>
            <span>
              ${isLoading
                ? html`<img alt="spinner" src="./assets/spinner.svg" />`
                : ""}
            </span>
            <span id="output"> ${output} </span>
            ${history.map((item) => {
              return html`<div
                style="display: flex;flex-direction: row;justify-content: space-between;"
              >
                <span style="color: ${item.actor === "user" ? "blue" : "red"}"
                  >${item.actor}</span
                >
                <span>${item.message}</span>
              </div>`;
            })}
          </div>
        `;
      }

      render(html`<${App} />`, document.getElementById("app"));
    </script>
  </head>
  <body>
    <main>
      <header-component></header-component>
      <div id="app"></div>
    </main>
  </body>
</html>
